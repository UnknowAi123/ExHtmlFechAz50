<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Extractor de Metadatos con MediaInfo.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      padding: 20px;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    input[type="file"] {
      margin: 10px 0;
    }
    .section {
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      margin: 10px 0;
    }
    .section h2 {
      margin: 10px 0;
      color: #444;
    }
    .section ul {
      list-style: none;
      padding: 0;
    }
    .section li {
      margin: 4px 0;
      word-wrap: break-word;
    }
    .section li strong {
      color: #222;
    }
    pre.json-output {
      background: #272822;
      color: #f8f8f2;
      padding: 10px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h1>Extractor de Metadatos (MP3, FLAC, WAV) con MediaInfo.js</h1>
  <input type="file" id="fileInput" accept=".mp3,.flac,.wav" />
  <div id="metadata">
    <!-- Aquí se mostrarán los metadatos -->
  </div>

  <!-- Cargamos MediaInfo.js desde jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/mediainfo.js/dist/mediainfo.min.js"></script>
  <script>
    // Función personalizada para instanciar el módulo WASM con un objeto de importación adecuado
    function customInstantiateWasm(imports, receiveInstance) {
      // Aseguramos que imports.env es un objeto y definimos 'memory' y 'table'
      if (!imports.env || typeof imports.env !== "object") {
        imports.env = {
          memory: new WebAssembly.Memory({ initial: 256 }),
          table: new WebAssembly.Table({ initial: 0, element: "anyfunc" })
        };
      } else {
        if (!imports.env.memory) {
          imports.env.memory = new WebAssembly.Memory({ initial: 256 });
        }
        if (!imports.env.table) {
          imports.env.table = new WebAssembly.Table({ initial: 0, element: "anyfunc" });
        }
      }

      // Cargamos el archivo WASM de forma manual
      fetch("MediaInfoModule.wasm")
        .then(response => response.arrayBuffer())
        .then(bytes => WebAssembly.instantiate(bytes, imports))
        .then(result => {
          receiveInstance(result.instance);
        })
        .catch(error => {
          console.error("Error instanciando el WASM:", error);
          throw error;
        });
      
      // Es necesario devolver un objeto vacío según la API de Emscripten
      return {};
    }

    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;
      
      document.getElementById('metadata').innerHTML = "<p>Cargando metadatos...</p>";

      // Inicializamos MediaInfo, especificando locateFile y nuestra función custom para instanciar el WASM
      MediaInfo({
        locateFile: (filename) => {
          // Como MediaInfoModule.wasm se encuentra en la misma carpeta que index.html, devolvemos solo su nombre.
          return "MediaInfoModule.wasm";
        },
        instantiateWasm: customInstantiateWasm
      }).then(mediaInfo => {
        // Funciones para leer el archivo en trozos (chunks)
        const getSize = () => file.size;
        const readChunk = (chunkSize, offset) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = event => resolve(new Uint8Array(event.target.result));
            reader.onerror = error => reject(error);
            reader.readAsArrayBuffer(file.slice(offset, offset + chunkSize));
          });
        };

        // Analizamos el archivo utilizando mediaInfo.analyzeData()
        mediaInfo.analyzeData(getSize, readChunk).then(result => {
          console.log("Resultado de MediaInfo:", result);
          let html = "";

          if (result.media && result.media.track) {
            result.media.track.forEach(track => {
              html += `<div class="section"><h2>${track["@type"]}</h2><ul>`;
              for (const key in track) {
                if (key !== "@type") {
                  html += `<li><strong>${key}:</strong> ${track[key]}</li>`;
                }
              }
              html += "</ul></div>";
            });
          } else {
            html = "<p>No se encontraron metadatos.</p>";
          }

          // Mostramos también el JSON completo para referencia
          html += "<h2>JSON Completo:</h2><pre class='json-output'>" + JSON.stringify(result, null, 2) + "</pre>";
          document.getElementById('metadata').innerHTML = html;
        }).catch(error => {
          console.error("Error analizando el archivo:", error);
          document.getElementById('metadata').innerHTML = `<p>Error analizando el archivo: ${error}</p>`;
        });
      }).catch(error => {
        console.error("Error inicializando MediaInfo:", error);
        document.getElementById('metadata').innerHTML = `<p>Error inicializando MediaInfo: ${error}</p>`;
      });
    });
  </script>
</body>
</html>
