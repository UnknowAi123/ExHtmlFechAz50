<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extraer Enlaces de HTML - Optimizado para Chrome y Firefox</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; }
    input, button { width: 80%; padding: 10px; margin: 10px 0; }
    button { font-size: 16px; cursor: pointer; }

    /* ------------------- Ajuste optimizado para Chrome ------------------- */
    @media screen and (-webkit-min-device-pixel-ratio:0) {
      #resultado {
        font-size: 11px !important; /* Letra más pequeña en modo PC */
        font-family: Arial, sans-serif !important;
        zoom: 0.85;
        transform: scale(0.85);
        transform-origin: top left;
        word-break: break-word;
        margin: 20px auto !important; /* Centrado en todos los modos */
        max-width: 98% !important; /* Caja más ancha */
      }
    }

    /* ------------------- Ajuste específico para Firefox ------------------- */
    @-moz-document url-prefix() {
      #resultado {
        font-size: 14px; /* Aumentar tamaño en Firefox modo PC */
      }
    }

    /* ------------------- Ajuste General ------------------- */
    #resultado {
      text-align: left;
      max-width: 98%;
      margin: 20px auto;
      display: block;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      background: #f4f4f4;
      word-wrap: break-word;
    }

    /* Ajuste para móviles: caja más ancha */
    @media (max-width: 768px) {
      #resultado {
        font-size: 13px; /* Aumento ligero en móviles */
        max-width: 100%;
      }
    }

    /* Corrección del espacio blanco al final de la página */
    html, body { overflow-x: hidden; height: auto; }

    #mensajeCargar, #mensajeExtraer, #mensajeExportar {
      text-align: center;
      font-weight: bold;
      padding: 5px;
      margin-top: 10px;
    }

    .positivo { color: green; }
    .negativo { color: red; }
  </style>
</head>
<body>
  <h1>Extraer Enlaces de HTML</h1>
  <p>Sube un archivo HTML de marcadores y visualiza solo los enlaces ordenados.</p>

  <button onclick="document.getElementById('archivo').click()">CARGAR Y PROCESAR POR FECHA</button>
  <button onclick="document.getElementById('archivoAZ').click()">CARGAR Y PROCESAR A-Z</button>
  <input type="file" id="archivo" style="display: none;" accept=".html" onchange="validarYProcesarArchivo('fecha')">
  <input type="file" id="archivoAZ" style="display: none;" accept=".html" onchange="validarYProcesarArchivo('az')">

  <div id="mensajeCargar"></div>
  <div id="mensajeExtraer"></div>

  <button onclick="exportarHTML()">EXPORTAR HTML</button>
  <div id="mensajeExportar"></div>

  <h2>Marcadores:</h2>
  <pre id="resultado"></pre>

  <script>
    function validarYProcesarArchivo(metodoOrden) {
      const archivo = document.getElementById(metodoOrden === "fecha" ? "archivo" : "archivoAZ").files[0];
      if (!archivo) return mostrarMensaje("Error (Ningún archivo cargado)", "mensajeCargar", "negativo");

      if (!archivo.name.endsWith(".html")) {
        document.getElementById(metodoOrden === "fecha" ? "archivo" : "archivoAZ").value = "";
        return mostrarMensaje("Error (Formato incorrecto, debe ser HTML)", "mensajeCargar", "negativo");
      }

      mostrarMensaje("Cargado y procesando...", "mensajeCargar", "positivo");
      procesarEnlaces(archivo, metodoOrden);
    }

    function procesarEnlaces(archivo, metodoOrden) {
      const reader = new FileReader();
      reader.onload = () => extraerEnlaces(reader.result, metodoOrden);
      reader.onerror = () => mostrarMensaje("Error (Fallo de Lectura)", "mensajeExtraer", "negativo");
      reader.readAsText(archivo);
    }

    function extraerEnlaces(html, metodoOrden) {
      const doc = new DOMParser().parseFromString(html, "text/html");
      let enlaces = [];

      doc.querySelectorAll("DL > DT > H3").forEach(carpeta => {
        const nombreCarpeta = carpeta.innerText.trim();
        if (nombreCarpeta === "Marcadores" || nombreCarpeta === "Marcadores de móvil") return;

        carpeta.nextElementSibling.querySelectorAll("DT > A").forEach(enlace => {
          const titulo = enlace.innerText.trim();
          const rawUrl = enlace.getAttribute("HREF").trim();
          const addDate = enlace.getAttribute("ADD_DATE");

          if (addDate) enlaces.push(formatearEnlace(addDate, rawUrl, titulo, nombreCarpeta));
        });
      });

      enlaces.sort(metodoOrden === "fecha"
        ? (a, b) => a.fecha - b.fecha
        : (a, b) => a.dominio.localeCompare(b.dominio, "es", { numeric: true }) || a.fecha - b.fecha);

      mostrarResultado(enlaces);
      mostrarMensaje("Procesado!", "mensajeExtraer", "positivo");
    }

    function formatearEnlace(addDate, url, titulo, carpeta) {
      const fecha = new Date(parseInt(addDate) * 1000);
      const fechaTexto = `${fecha.getDate().toString().padStart(2, "0")}/${(fecha.getMonth() + 1).toString().padStart(2, "0")}/${fecha.getFullYear().toString().slice(-2)}-${fecha.toLocaleTimeString("es-ES", { hour12: false })}`;

      let hostname;
      try { hostname = new URL(url).hostname.toLowerCase(); } catch (e) { hostname = ""; }
      if (hostname.startsWith("www.")) hostname = hostname.substring(4);

      const dominioPrincipal = hostname.split(".").slice(-2).join(".").toUpperCase();

      return {
        fecha,
        fechaTexto,
        dominio: dominioPrincipal,
        titulo,
        url: `<a href="${limpiarURL(url)}" target="_blank">${limpiarURL(url)}</a>`,
        carpeta
      };
    }

    function limpiarURL(url) {
      try {
        const parsedUrl = new URL(url);
        parsedUrl.search = "";
        return parsedUrl.href;
      } catch (error) {
        return url;
      }
    }

    function mostrarResultado(enlaces) {
      document.getElementById("resultado").innerHTML = enlaces.map(enlace =>
        `<strong>${enlace.dominio}</strong><br>${enlace.fechaTexto}<br>${enlace.titulo}<br>${enlace.url}<br>[#${enlace.carpeta}]<br><br>`
      ).join("");
    }
  </script>
</body>
</html>
