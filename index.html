<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Audio Mejorado</title>
    <script src="https://cdn.jsdelivr.net/npm/music-metadata-browser/dist/music-metadata-browser.umd.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #output { margin-top: 20px; white-space: pre-wrap; text-align: left; }
        #progressBar { width: 100%; height: 20px; background: #ccc; display: none; }
        #progressFill { width: 0%; height: 100%; background: #4caf50; }
    </style>
</head>
<body>

    <h1>Analizador de Archivos de Audio</h1>
    <input type="file" id="fileInput" accept=".mp3,.flac,.wav,.ogg,.aac">
    <button onclick="exportToHTML()">Exportar Info a HTML</button>
    
    <div id="progressBar"><div id="progressFill"></div></div>
    <pre id="output"></pre>

    <script>
        document.getElementById('fileInput').addEventListener('change', handleFile);

        async function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = "block"; 
            progressFill.style.width = "0%";

            const output = document.getElementById('output');
            output.textContent = "Procesando archivo...\n";

            // Simular progreso
            progressFill.style.width = "50%"; 

            // Leer metadatos con music-metadata
            const metadata = await musicMetadata.parseBlob(file);
            output.textContent = `Archivo: ${file.name}\nTamaño: ${(file.size / 1024).toFixed(2)} KB\nTipo: ${file.type}\n`;
            output.textContent += `Título: ${metadata.common.title || "Desconocido"}\n`;
            output.textContent += `Artista: ${metadata.common.artist || "Desconocido"}\n`;
            output.textContent += `Álbum: ${metadata.common.album || "Desconocido"}\n`;
            output.textContent += `Género: ${metadata.common.genre ? metadata.common.genre.join(", ") : "Desconocido"}\n`;
            output.textContent += `Duración: ${metadata.format.duration ? metadata.format.duration.toFixed(2) + " s" : "No disponible"}\n`;
            output.textContent += `Bitrate: ${metadata.format.bitrate ? metadata.format.bitrate + " kbps" : "No disponible"}\n`;
            output.textContent += `Frecuencia de muestreo: ${metadata.format.sampleRate || "No disponible"} Hz\n`;

            // Generar hash del archivo
            const hash = await generateHash(await file.arrayBuffer());
            output.textContent += `Hash SHA-256: ${hash}\n`;

            progressFill.style.width = "100%"; 
            setTimeout(() => progressBar.style.display = "none", 1000);
        }

        async function generateHash(buffer) {
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function exportToHTML() {
            const content = document.getElementById('output').textContent;
            const blob = new Blob([`<pre>${content}</pre>`], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'audio_info.html';
            a.click();
        }
    </script>

</body>
</html>
